!function(){"use strict";function e(e,t){return"string"==typeof e?(t||document).querySelector(e):null}function t(e,t){return[].slice.call((t||document).querySelectorAll(e))}function n(e,t){"object"==typeof e&&e||(e={});for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n]);return e}function i(t,s){if(t instanceof i)return t;if(t instanceof HTMLElement&&!(this instanceof i))return new i(t,s);if(!(this instanceof i))return(t=e(t,s instanceof i?s.dom:s))?new i(t):null;s=n(s,{appendTo:null,context:document,html:"",insertAfter:null,insertBefore:null,replace:null});var o,r,l=t instanceof HTMLElement?t:null;if("string"==typeof t){r=function(e,t){return e.match(/(\[[^\]]+\]|#[^#.\[]+|\.[^#.\[]+|\w+)/g).forEach(function(e){"["==e[0]?(e=e.match(/^\[([^=\]]+)=?([^\]]+)?\]$/))&&(t.attribs[e[1]]=e[2]||""):"."==e[0]?t.classes.push(e.substr(1)):"#"==e[0]?t.attribs.id=e.substr(1):t.tag=e}),t}(t,{attribs:{},classes:[]}),l=s.context.createElement(r.tag),r.classes.forEach(function(e){l.classList.add(e)});for(o in r.attribs)r.attribs.hasOwnProperty(o)&&l.setAttribute(o,r.attribs[o])}this.events={},this.dom=t instanceof HTMLElement?t:l,this.parent=t instanceof HTMLElement?i(t.parentElement):null,s.html&&l&&(l.innerHTML=s.html),(o=i(s.replace))?o.parent.replace(this,o):(o=i(s.appendTo))?o.append(this):(o=i(s.insertAfter))?o.parent.append(this,o):(o=i(s.insertBefore))&&o.parent.insert(this,o)}function s(e,t){this._files=[],this._form=null,this._i18n=s.i18n.en_GB,this._parent=i(e),this._status=s.status.READY,this._options=n(t,{accept:"*/*",autoResize:!0,chunked:!1,chunkSize:1048576,className:"filefunnel",multiple:!1}),this.locale=t.locale||(navigator?(navigator.userLanguage||navigator.language).replace("-","_"):null),this.build()}return i.prototype={add:function(e){return(e instanceof Array?e:[e]).forEach(function(e){(e=i(e))&&(this.dom.appendChild(e.dom),e.parent=this)},this),this},append:function(e,t){return(t=this.child(t))?this.dom.insertBefore(i(e).dom,t.dom.nextElementSibling):this.dom.appendChild(i(e).dom),e instanceof i&&(e.parent=this),this},attrib:function(e,t){if("string"==typeof e){if(void 0===t)return this.dom.getAttribute(e);this.dom.setAttribute(e,t)}return t},child:function(n){if("string"==typeof n){var s,o,r,l,a=this.dom;if(n.split(" ").forEach(function(t,n,i){a&&n<i.length-1&&(a=e(t,a))}),a){o=[].slice.call(a.children),l=t(n,a);for(r in l)for(s in o)if(l[r]===o[s])return i(o[s])}}else{if(n instanceof i)return n.dom.parentElement===this.dom?n:null;if(n instanceof HTMLElement)return n.parentElement===this.dom?i(n):null}return null},get classes(){return this.dom.classList},clear:function(){for(var e,t=this.dom;e=t.firstChild;)t.removeChild(e);return this},get enabled(){return!this.dom.hasAttribute("disabled")},set enabled(e){return e?this.dom.removeAttribute("disabled"):this.dom.setAttribute("disabled",""),this.enabled},focus:function(){this.dom.focus(),this.dom.selectionStart=this.value.length},get html(){return this.dom.innerHTML},set html(e){return this.dom.innerHTML=e},insert:function(e,t){return this.dom.insertBefore(i(e).dom,(t=this.child(t))?t.dom:this.dom.firstElementChild),e instanceof i&&(e.parent=this),this},on:function(e,t,n){return(e instanceof Array?e:[e]).forEach(function(e){if("string"==typeof e){var i=this,s="function"==typeof t?function(e){return t.call(n||i,e)}:null;i.events[e]instanceof Array||(i.events[e]=[]),s?(i.events[e].push(s),i.dom.addEventListener(e,s)):i.events[e].forEach(function(t,n,s){i.dom.removeEventListener(e,t),s.splice(n,1)})}},this),this},remove:function(e){(e=i(e))&&this.dom.removeChild(e.dom)},replace:function(e,t){return(e=new i(e))&&(t=i(t,this))&&(this.dom.replaceChild(e.dom,t.dom),e.parent=this,t.parent=null),this},get value(){return void 0!==this.dom.value?this.dom.value:this.html},set value(e){return void 0!==this.dom.value?this.dom.value=e:this.html=e},get visible(){return!this.dom.hasAttribute("hidden")},set visible(e){return e?this.dom.removeAttribute("hidden"):this.dom.setAttribute("hidden",""),this.visible}},s.VERSION=.22,s.status={READY:0,UPLOADING:1,COMPLETED:3,ABORTED:4,ERROR:5},s.prototype={build:function(){var e=this,t=e._files,n=e._i18n,o=e._options,r=e._parent,l="string"==typeof o.accept?o.accept:"*/*",a=(!0===o.multiple?"[multiple]":"",{form:new i("form[enctype=multipart/form-data]."+o.className),browseButton:new i("input[type=button][value="+(o.multiple?n.browseMultiple:n.browse)+"].browse"),fileInput:new i("input[type=file][accept="+l+"][hidden][multiple]"),fileList:new i("div.filelist"),submitButton:new i("input[type=submit][value="+n.upload+"][disabled].submit"),resetButton:new i("input[type=reset][value="+n.reset+"].reset")});return!0!==o.multiple&&a.fileInput.dom.removeAttribute("multiple"),a.form.add([a.browseButton,a.fileInput,a.fileList,a.submitButton,a.resetButton]),e._form&&e._form.parent?form.parent.replace(e._form=a.form,e._form):r&&r.dom instanceof HTMLInputElement?(r.parent.append(e._form=a.form,r),e.hide().resize(),r.on("click",function(){e.toggle()}),document.addEventListener("click",function(t,n){if(e._form.visible){for(;n=n?n.parentNode:t.target;)if(n==e._form.dom||n==r.dom)return;e.hide()}}),window.addEventListener("resize",function(){!0===o.autoResize&&e.resize()})):r&&r.append(e._form=a.form),a.browseButton.on("click",function(){a.fileInput.dom.click()}),a.fileInput.on("change",function(e){t.length=0,a.fileList.clear(),a.fileListItems=[],[].slice.call(e.target.files).forEach(function(e){var s=e.size,o=(e.lastModifiedDate,{});s=s>=1073741824?(s/1073741824).toFixed(2)+n.gibiBytes:s>=1048576?(s/1048576).toFixed(2)+n.mebiBytes:s>=1024?(s/1024).toFixed(2)+n.kibiBytes:s+=n.bytes,a.fileList.add(new i("fieldset.fileinfo").append(new i("legend",{html:e.name})).append(o.name=new i("input[type=text][placeholder="+n.fileName+"][value="+e.name+"].name")).append(o.size=new i("input[type=text][placeholder="+n.fileSize+"][value="+s+"][disabled].size")).append(o.type=new i("input[type=text][placeholder="+n.fileType+"][value="+e.type+"][disabled].type")).append(o.prog=new i("progress[value=0].progress")).append(o.info=new i("span.info"))),t.push({elements:o,finished:!1,reference:e,xhr:null})}),a.submitButton.enabled=e.target.files.length}),a.form.on("submit",function(i){function r(i){i.finished=!0;for(var o in t)if(!t[o].finished)return;a.fileInput.enabled=!0,a.resetButton.value=n.reset,e._status=s.status.COMPLETED}if(i.preventDefault(),a.fileInput.enabled=a.submitButton.enabled=!1,a.resetButton.value=n.cancel,e._status=s.status.UPLOADING,o.chunked){var l="number"==typeof o.chunkSize?o.chunkSize:1048576;t.forEach(function(t){var i=0,a=t.reference.size,u=t.elements.name.value,f=function(){var c=t.reference.slice(i,Math.min(a,i+l)+1,t.reference.type),d=t.xhr=new XMLHttpRequest;d.upload.onloadstart=function(e){t.elements.prog.attrib("max",a+(e.lengthComputable?e.total:0)),t.elements.prog.value=i},d.upload.onloadend=function(e){t.elements.prog.attrib("max",a),t.elements.prog.value=i+=c.size,a>i?"function"==typeof f?f():r(t):e.total>0&&(t.elements.info.classes.add("success"),t.elements.info.value=n.success,r(t))},d.upload.onprogress=function(e){e.lengthComputable&&(t.elements.prog.value=i+e.loaded)},d.onreadystatechange=function(i){if(i.target.status>=400)switch(e._status=s.status.ERROR,t.elements.prog.attrib("max",t.elements.prog.value=0),t.elements.info.classes.add("error"),f=null,r(t),i.target.status){case 401:case 403:t.elements.info.value=n.forbidden;break;case 413:t.elements.info.value=n.oversized;break;default:t.elements.info.value=i.target.statusText}},d.onerror=function(){e._status=s.status.ERROR,t.elements.prog.attrib("max",t.elements.prog.value=0),t.elements.info.classes.add("error"),t.elements.info.value=n.refused,f=null,r(t)},d.open("POST",o.server,!0),d.setRequestHeader("Content-Type",c.type),d.setRequestHeader("X-File-Name",u),d.setRequestHeader("X-File-Size",a),d.send(c)};t.elements.prog.attrib("max",a),f()})}else{var u=t.xhr=new XMLHttpRequest,f=new FormData;u.onreadystatechange=function(i){i.target.status>=200&&i.target.status<300&&t.forEach(function(t){e._status=s.status.COMPLETED,t.elements.prog.attrib("max",i.total||1),t.elements.prog.attrib("value",i.loaded||1),t.elements.info.classes.add("success"),t.elements.info.value=n.success,r(t)})},u.onerror=function(i){t.forEach(function(t){e._status=s.status.ERROR,t.elements.prog.attrib("max",t.elements.prog.value=0),t.elements.info.classes.add("error"),t.elements.info.value=n.refused,r(t)})},t.forEach(function(e){f.append(e.reference.name,e.reference,e.elements.name.value),e.elements.prog.dom.removeAttribute("value")}),u.open("POST",o.server,!0),u.send(f)}}),a.form.on("reset",function(){a.fileList.clear(),a.fileListItems=[],a.fileInput.enabled=!0,a.submitButton.enabled=!1,a.resetButton.value=n.reset}),this},hide:function(){return this._form&&(this._form.visible=!1),this},get locale(){return this._i18n},set locale(e){s.i18n[e]&&s.i18n[e]!==this._i18n&&(this._i18n=s.i18n[e])},resize:function(e){return this._form&&this._parent&&(this._form.dom.style.width=(isNaN(e=Number(e))?this._parent.dom.offsetWidth:e)+"px"),this},show:function(){return this._form&&(this._form.visible=!0),this},toggle:function(){return this._form&&(this._form.visible=!this._form.visible),this}},s.i18n={en_GB:{browse:"Choose file",browseMultiple:"Choose files",cancel:"Cancel","delete":"Delete",reset:"Reset",upload:"Upload",bytes:" bytes",gibiBytes:" GiB",kibiBytes:" KiB",mebiBytes:" MiB",fileName:"Filename",fileSize:"Filesize",fileType:"Filetype",forbidden:"Unauthorised for upload",oversized:"File too big for upload",refused:"Connection refused",success:"Upload successful"}},"undefined"!=typeof window&&(window.FileFunnel=s),"object"==typeof module&&module.exports&&(module.exports=s),s}();