!function(){"use strict";function e(e,t){return"string"==typeof e?(t||document).querySelector(e):null}function t(e,t){return[].slice.call((t||document).querySelectorAll(e))}function n(t,s){if(t instanceof n)return t;if(t instanceof HTMLElement&&!(this instanceof n))return new n(t,s);if(!(this instanceof n))return(t=e(t,s instanceof n?s.dom:s))?new n(t):null;s=Object.assign({appendTo:null,context:document,html:"",insertAfter:null,insertBefore:null,replace:null},s);var o,i,r=t instanceof HTMLElement?t:null;if("string"==typeof t){i=function(e,t){return e.match(/(\[[^\]]+\]|#[^#.\[]+|\.[^#.\[]+|\w+)/g).forEach(function(e){"["==e[0]?(e=e.match(/^\[([^=\]]+)=?([^\]]+)?\]$/))&&(t.attribs[e[1]]=e[2]||""):"."==e[0]?t.classes.push(e.substr(1)):"#"==e[0]?t.attribs.id=e.substr(1):t.tag=e}),t}(t,{attribs:{},classes:[]}),r=s.context.createElement(i.tag),i.classes.forEach(function(e){r.classList.add(e)});for(o in i.attribs)i.attribs.hasOwnProperty(o)&&r.setAttribute(o,i.attribs[o])}this.events={},this.dom=t instanceof HTMLElement?t:r,this.parent=t instanceof HTMLElement?n(t.parentElement):null,s.html&&r&&(r.innerHTML=s.html),(o=n(s.replace))?o.parent.replace(o,this):(o=n(s.appendTo))?o.append(this):(o=n(s.insertAfter))?o.parent.append(this,o):(o=n(s.insertBefore))&&o.parent.insert(this,o);var a=this.dom,l={add:function(){return[].slice.call(arguments).forEach(function(e){a.setAttribute(e,"")}),a.attributes},get:function(e){return a.getAttribute(arg)},remove:function(){return[].slice.call(arguments).forEach(function(e){a.removeAttribute(e)}),a.attributes},set:function(e,t){return a.setAttribute(e,t),a.attributes}};for(var u in l)a.attributes[u]=l[u]}function s(e,t){return this._callbacks={},this._elements={},this._i18n={},this._parent=n(e),this._options=Object.assign({accept:"*/*",autoResize:!0,chunked:!1,chunkSize:1048576,className:"filefunnel",multiple:!1,progress:!1},t),this.files=[],this.locale=this._options.locale||(navigator?(navigator.userLanguage||navigator.language).replace("-","_"):null),this.status=s.status.NONE,this.build()}return"function"!=typeof Object.assign&&(Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");var t,n,s,o=Object(e);for(t=1;t<arguments.length;++t)if(void 0!==(n=arguments[t])&&null!==n)for(s in n)n.hasOwnProperty(s)&&(o[s]=n[s]);return o}),n.prototype={add:function(e){return(e instanceof Array?e:[e]).forEach(function(e){(e=n(e))&&(this.dom.appendChild(e.dom),e.parent=this)},this),this},append:function(e,t){return(t=this.child(t))?this.dom.insertBefore(n(e).dom,t.dom.nextElementSibling):this.dom.appendChild(n(e).dom),e instanceof n&&(e.parent=this),this},get attribs(){return this.dom.attributes},child:function(s){if("string"==typeof s){var o,i,r,a,l=this.dom;if(s.split(" ").forEach(function(t,n,s){l&&n<s.length-1&&(l=e(t,l))}),l){i=[].slice.call(l.children),a=t(s,l);for(r in a)for(o in i)if(a[r]===i[o])return n(i[o])}}else{if(s instanceof n)return s.dom.parentElement===this.dom?s:null;if(s instanceof HTMLElement)return s.parentElement===this.dom?n(s):null}return null},get classes(){return this.dom.classList},clear:function(){for(var e,t=this.dom;e=t.firstChild;)t.removeChild(e);return this},get enabled(){return!this.dom.hasAttribute("disabled")},set enabled(e){return e?this.dom.removeAttribute("disabled"):this.dom.setAttribute("disabled",""),this.enabled},focus:function(){this.dom.focus(),this.dom.selectionStart=this.value.length},get html(){return this.dom.innerHTML},set html(e){return this.dom.innerHTML=e},insert:function(e,t){return this.dom.insertBefore(n(e).dom,(t=this.child(t))?t.dom:this.dom.firstElementChild),e instanceof n&&(e.parent=this),this},on:function(e,t,n){return(e instanceof Array?e:[e]).forEach(function(e){if("string"==typeof e){var s=this,o="function"==typeof t?function(e){return t.call(n||s,e)}:null;s.events[e]instanceof Array||(s.events[e]=[]),o?(s.events[e].push(o),s.dom.addEventListener(e,o)):s.events[e].forEach(function(t,n,o){s.dom.removeEventListener(e,t),o.splice(n,1)})}},this),this},remove:function(e){(e=n(e))&&this.dom.removeChild(e.dom)},replace:function(e,t){return(t=new n(t))&&(e=n(e,this))&&(this.dom.replaceChild(t.dom,e.dom),t.parent=this,e.parent=null),this},get value(){return void 0!==this.dom.value?this.dom.value:this.html},set value(e){return void 0!==this.dom.value?this.dom.value=e:this.html=e},get visible(){return!this.dom.hasAttribute("hidden")},set visible(e){return e?this.dom.removeAttribute("hidden"):this.dom.setAttribute("hidden",""),this.visible}},s.VERSION=.56,s.status={NONE:0,READY:1,UPLOADING:2,COMPLETED:3,ABORTED:4,FAILED:5},s.prototype={abort:function(){this._elements.resetButton&&this._elements.resetButton.dom.click()},browse:function(){this._elements.fileInput&&this._elements.fileInput.dom.click()},build:function(){var e=this,t=e.files,o=e._i18n,i=e._options,r=e._parent,a="string"==typeof i.accept?i.accept:"*/*",l={form:new n("form[enctype=multipart/form-data][method=POST]."+i.className),browseButton:new n("input[type=button][value="+(i.multiple?o.add:o.browse)+"].browse"),fileInput:new n("input[type=file][accept="+a+"][hidden][multiple]"),fileList:new n("div.filelist"),submitButton:new n("input[type=submit][value="+o.upload+"][disabled].submit"),resetButton:new n("input[type=reset][value="+o.reset+"].reset")},u={401:o.forbidden,403:o.forbidden,413:o.oversized};return!0!==i.multiple&&l.fileInput.dom.removeAttribute("multiple"),l.form.add([l.browseButton,l.fileInput,l.fileList,l.submitButton,l.resetButton]),r&&(e._elements.form&&e._elements.form.parent?e._elements.form.parent.replace(e._elements.form,l.form):r.dom instanceof HTMLInputElement?(r.parent.append(l.form,r),l.form.classes.add("widget"),e._elements=l,e.hide().resize(),r.on("click",function(){e.toggle()}),document.addEventListener("click",function(t,n){if(l.form.visible){for(;n=n?n.parentNode:t.target;)if(n==l.form.dom||n==r.dom)return;e.hide()}}),window.addEventListener("resize",function(){!0===i.autoResize&&e.resize()})):r.append(l.form)),e._elements=l,l.browseButton.on("click",function(){l.fileInput.dom.click()}),l.fileInput.on("change",function(r){i.multiple||(t.length=0,l.fileList.clear()),[].slice.call(r.target.files).forEach(function(i){for(var r,a=i.size,u=i.lastModifiedDate,c={},f=0;f<t.length;++f)if((r=t[f].reference).name==i.name&&r.lastModifiedDate.valueOf()==u.valueOf())return;a=a>=1073741824?(a/1073741824).toFixed(2)+o.gibiBytes:a>=1048576?(a/1048576).toFixed(2)+o.mebiBytes:a>=1024?(a/1024).toFixed(2)+o.kibiBytes:a+=o.bytes,l.fileList.add(new n("fieldset.fileinfo").append(new n("legend",{html:i.name})).append(c.name=new n("input[type=text][placeholder="+o.fileName+"][value="+i.name+"].name")).append(c.size=new n("input[type=text][placeholder="+o.fileSize+"][value="+a+"][disabled].size")).append(c.type=new n("input[type=text][placeholder="+o.fileType+"][value="+i.type+"][disabled].type")).append(c.prog=new n("progress[value=0].progress")).append(c.info=new n("span.info"))),t.push({bytesSent:0,bytesTotal:i.size,elements:c,location:null,parent:e,reference:i,response:null,status:s.status.READY,xhr:null,get progress(){return s.status.UPLOADING==this.status?Math.round(this.bytesSent/this.bytesTotal*100):NaN}})}),e.status=t.length?s.status.READY:s.status.NONE,l.submitButton.enabled=t.length}),l.form.on("submit",function(t){t.preventDefault(),e.upload()}),e.upload=function(){function n(n){for(var i in t)if(s.status.UPLOADING==t[i].status)return;l.resetButton.on("click",null),l.resetButton.value=o.reset,e.status=s.status.COMPLETED}if(l.browseButton.enabled=l.submitButton.enabled=!1,l.resetButton.value=o.cancel,e.status=s.status.UPLOADING,l.resetButton.on("click",function(e){if(e.preventDefault(),i.chunked)for(var n in t)t[n].xhr instanceof XMLHttpRequest&&t[n].xhr.abort();else t.xhr instanceof XMLHttpRequest&&t.xhr.abort()}),i.chunked){var r="number"==typeof i.chunkSize?i.chunkSize:1048576;t.forEach(function(t){var a=t.elements.name.value,l=function(){var c=t.reference.slice(t.bytesSent,Math.min(t.bytesTotal,t.bytesSent+r)+1,t.reference.type),f=t.xhr=new XMLHttpRequest;f.onloadstart=function(n){t.status=s.status.UPLOADING,"function"==typeof e._callbacks.start&&e._callbacks.start(t)},f.upload.onprogress=function(n){n.lengthComputable&&(t.elements.prog.value=t.bytesSent+n.loaded),"function"==typeof e._callbacks.progress&&e._callbacks.progress(t)},f.onload=function(i){var r=i.target.status;if(r>=200&&300>r){if(t.elements.prog.attribs.set("max",t.bytesTotal).set("value",t.bytesSent+=c.size),t.bytesSent<t.bytesTotal)return"function"==typeof l&&l();t.status=s.status.COMPLETED,t.elements.info.classes.add("success"),t.elements.info.value=o.success,n(t),201==r&&(t.location=f.getResponseHeader("Content-Location")||null,t.response=f.responseText||null),"function"==typeof e._callbacks.success&&e._callbacks.success(t)}else r>=400&&(t.status=s.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=u[r]||o.failed,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t))},f.onabort=function(){t.status=s.status.ABORTED,t.elements.info.value=o.aborted,n(t),"function"==typeof e._callbacks.abort&&e._callbacks.abort(t)},f.ontimeout=function(){t.status=s.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=o.timeout,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)},f.onerror=function(){t.status=s.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=o.refused,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)},f.open("POST",i.server,!0),f.setRequestHeader("Content-Type",c.type),f.setRequestHeader("X-File-Name",a),f.setRequestHeader("X-File-Size",t.bytesTotal),f.send(c)};t.elements.prog.attribs.set("max",t.bytesTotal),l()})}else{var a,c=t.xhr=new XMLHttpRequest,f=new FormData,d=0,m=0;c.onloadstart=function(n){t.forEach(function(t){t.status=s.status.UPLOADING,t.elements.prog.attribs.remove("max","value"),"function"==typeof e._callbacks.start&&e._callbacks.start(t)})},i.progress&&(c.upload.onprogress=function(n){n.lengthComputable&&((a=t[d])&&(a.elements.prog.attribs.set("max",a.bytesTotal).set("value",a.bytesSent=Math.min(a.bytesTotal,n.loaded-m)),a.bytesSent>=a.bytesTotal&&(m+=a.bytesTotal,++d>=t.length&&a.elements.prog.attribs.remove("max","value"))),"function"==typeof e._callbacks.progress&&e._callbacks.progress(a))}),c.onload=function(i){var r=i.target.status;t.forEach(function(t){r>=200&&300>r?(t.status=s.status.COMPLETED,t.elements.prog.attribs.set("max",1).set("value",1),t.elements.info.classes.add("success"),t.elements.info.value=u[r]||o.success,n(t),"function"==typeof e._callbacks.success&&e._callbacks.success(t)):r>=400&&(t.status=s.status.FAILED,t.elements.prog.attribs.set("max",1).set("value",0),t.elements.info.classes.add("error"),t.elements.info.value=u[r]||o.failed,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t))})},c.onabort=function(){t.forEach(function(t){t.status=s.status.ABORTED,t.elements.prog.attribs.set("max",1).set("value",0),t.elements.info.value=o.aborted,n(t),"function"==typeof e._callbacks.abort&&e._callbacks.abort(t)})},c.ontimeout=function(){t.forEach(function(t){t.status=s.status.FAILED,t.elements.prog.attribs.set("max",1).set("value",0),t.elements.info.classes.add("error"),t.elements.info.value=o.timeout,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)})},c.onerror=function(i){t.forEach(function(t){t.status=s.status.FAILED,t.elements.prog.attribs.set("max",1).set("value",0),t.elements.info.classes.add("error"),t.elements.info.value=o.refused,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)})},t.forEach(function(e){f.append(e.reference.name,e.reference,e.elements.name.value),e.elements.prog.dom.removeAttribute("value")}),c.open("POST",i.server,!0),c.send(f)}},l.form.on("reset",function(){t.length=0,l.fileList.clear(),l.browseButton.enabled=!0,l.submitButton.enabled=!1,l.resetButton.value=o.reset,e.status=s.status.NONE}),this},get element(){return this._parent?this._parent.dom:null},hide:function(){return this._elements.form&&(this._elements.form.visible=!1),this},get locale(){return this._i18n._id},set locale(e){return(this._i18n=Object.assign({_id:s.i18n[e]?e:"en_GB"},s.i18n.en_GB,s.i18n[e]))._id},on:function(e,t){return(e instanceof Array?e:[e]).forEach(function(e){if(-1==["start","progress","success","abort","error"].indexOf(e))throw"Unrecognized FileFunnel event: "+e;this._callbacks[e]="function"==typeof t?t:null},this),this},reset:function(){this._elements.form&&this._elements.form.dom.reset()},resize:function(e){return this._elements.form&&this._parent&&(this._elements.form.dom.style.width=(isNaN(e=Number(e))?this._parent.dom.offsetWidth:e)+"px"),this},get server(){return"string"==typeof this._options.server?this._options.server:null},set server(e){return this._options.server="string"==typeof e?e:null},show:function(){return this._elements.form&&(this._elements.form.visible=!0),this},toggle:function(){return this._elements.form&&(this._elements.form.visible=!this._elements.form.visible),this},upload:function(){}},s.i18n={en_GB:{add:"Add files",browse:"Choose file",cancel:"Cancel","delete":"Delete",reset:"Reset",upload:"Upload",bytes:" bytes",gibiBytes:" GiB",kibiBytes:" KiB",mebiBytes:" MiB",fileName:"Filename",fileSize:"Filesize",fileType:"Filetype",aborted:"Upload aborted",failed:"Upload failed",forbidden:"Unauthorised for upload",oversized:"File too big for upload",refused:"Connection refused",success:"Upload successful",timeout:"Upload timed out"}},"undefined"!=typeof window&&(window.FileFunnel=s),"object"==typeof module&&module.exports&&(module.exports=s),s}();