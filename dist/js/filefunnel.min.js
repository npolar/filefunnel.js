!function(){"use strict";function e(e,t){return"string"==typeof e?(t||document).querySelector(e):null}function t(e,t){return[].slice.call((t||document).querySelectorAll(e))}function n(t,s){if(t instanceof n)return t;if(t instanceof HTMLElement&&!(this instanceof n))return new n(t,s);if(!(this instanceof n))return(t=e(t,s instanceof n?s.dom:s))?new n(t):null;s=Object.assign({appendTo:null,context:document,html:"",insertAfter:null,insertBefore:null,replace:null},s);var i,o,r=t instanceof HTMLElement?t:null;if("string"==typeof t){o=function(e,t){return e.match(/(\[[^\]]+\]|#[^#.\[]+|\.[^#.\[]+|\w+)/g).forEach(function(e){"["==e[0]?(e=e.match(/^\[([^=\]]+)=?([^\]]+)?\]$/))&&(t.attribs[e[1]]=e[2]||""):"."==e[0]?t.classes.push(e.substr(1)):"#"==e[0]?t.attribs.id=e.substr(1):t.tag=e}),t}(t,{attribs:{},classes:[]}),r=s.context.createElement(o.tag),o.classes.forEach(function(e){r.classList.add(e)});for(i in o.attribs)o.attribs.hasOwnProperty(i)&&r.setAttribute(i,o.attribs[i])}this.events={},this.dom=t instanceof HTMLElement?t:r,this.parent=t instanceof HTMLElement?n(t.parentElement):null,s.html&&r&&(r.innerHTML=s.html),(i=n(s.replace))?i.parent.replace(this,i):(i=n(s.appendTo))?i.append(this):(i=n(s.insertAfter))?i.parent.append(this,i):(i=n(s.insertBefore))&&i.parent.insert(this,i);var a=this.dom,l={add:function(){return[].slice.call(arguments).forEach(function(e){a.setAttribute(e,"")}),a.attributes},get:function(e){return a.getAttribute(arg)},remove:function(){return[].slice.call(arguments).forEach(function(e){a.removeAttribute(e)}),a.attributes},set:function(e,t){return a.setAttribute(e,t),a.attributes}};for(var u in l)a.attributes[u]=l[u]}function s(e,t){return this._callbacks={},this._elements={},this._i18n={},this._parent=n(e),this._options=Object.assign({accept:"*/*",autoResize:!0,chunked:!1,chunkSize:1048576,className:"filefunnel",multiple:!1},t),this.files=[],this.locale=this._options.locale||(navigator?(navigator.userLanguage||navigator.language).replace("-","_"):null),this.status=s.status.NONE,this.build()}return"function"!=typeof Object.assign&&(Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");var t,n,s,i=Object(e);for(t=1;t<arguments.length;++t)if(void 0!==(n=arguments[t])&&null!==n)for(s in n)n.hasOwnProperty(s)&&(i[s]=n[s]);return i}),n.prototype={add:function(e){return(e instanceof Array?e:[e]).forEach(function(e){(e=n(e))&&(this.dom.appendChild(e.dom),e.parent=this)},this),this},append:function(e,t){return(t=this.child(t))?this.dom.insertBefore(n(e).dom,t.dom.nextElementSibling):this.dom.appendChild(n(e).dom),e instanceof n&&(e.parent=this),this},get attribs(){return this.dom.attributes},child:function(s){if("string"==typeof s){var i,o,r,a,l=this.dom;if(s.split(" ").forEach(function(t,n,s){l&&n<s.length-1&&(l=e(t,l))}),l){o=[].slice.call(l.children),a=t(s,l);for(r in a)for(i in o)if(a[r]===o[i])return n(o[i])}}else{if(s instanceof n)return s.dom.parentElement===this.dom?s:null;if(s instanceof HTMLElement)return s.parentElement===this.dom?n(s):null}return null},get classes(){return this.dom.classList},clear:function(){for(var e,t=this.dom;e=t.firstChild;)t.removeChild(e);return this},get enabled(){return!this.dom.hasAttribute("disabled")},set enabled(e){return e?this.dom.removeAttribute("disabled"):this.dom.setAttribute("disabled",""),this.enabled},focus:function(){this.dom.focus(),this.dom.selectionStart=this.value.length},get html(){return this.dom.innerHTML},set html(e){return this.dom.innerHTML=e},insert:function(e,t){return this.dom.insertBefore(n(e).dom,(t=this.child(t))?t.dom:this.dom.firstElementChild),e instanceof n&&(e.parent=this),this},on:function(e,t,n){return(e instanceof Array?e:[e]).forEach(function(e){if("string"==typeof e){var s=this,i="function"==typeof t?function(e){return t.call(n||s,e)}:null;s.events[e]instanceof Array||(s.events[e]=[]),i?(s.events[e].push(i),s.dom.addEventListener(e,i)):s.events[e].forEach(function(t,n,i){s.dom.removeEventListener(e,t),i.splice(n,1)})}},this),this},remove:function(e){(e=n(e))&&this.dom.removeChild(e.dom)},replace:function(e,t){return(e=new n(e))&&(t=n(t,this))&&(this.dom.replaceChild(e.dom,t.dom),e.parent=this,t.parent=null),this},get value(){return void 0!==this.dom.value?this.dom.value:this.html},set value(e){return void 0!==this.dom.value?this.dom.value=e:this.html=e},get visible(){return!this.dom.hasAttribute("hidden")},set visible(e){return e?this.dom.removeAttribute("hidden"):this.dom.setAttribute("hidden",""),this.visible}},s.VERSION=.54,s.status={NONE:0,READY:1,UPLOADING:2,COMPLETED:3,ABORTED:4,FAILED:5},s.prototype={abort:function(){this._elements.resetButton&&this._elements.resetButton.dom.click()},browse:function(){this._elements.fileInput&&this._elements.fileInput.dom.click()},build:function(){var e=this,t=e.files,i=e._i18n,o=e._options,r=e._parent,a="string"==typeof o.accept?o.accept:"*/*",l={form:new n("form[enctype=multipart/form-data][method=POST]."+o.className),browseButton:new n("input[type=button][value="+(o.multiple?i.add:i.browse)+"].browse"),fileInput:new n("input[type=file][accept="+a+"][hidden][multiple]"),fileList:new n("div.filelist"),submitButton:new n("input[type=submit][value="+i.upload+"][disabled].submit"),resetButton:new n("input[type=reset][value="+i.reset+"].reset")},u={401:i.forbidden,403:i.forbidden,413:i.oversized};return!0!==o.multiple&&l.fileInput.dom.removeAttribute("multiple"),l.form.add([l.browseButton,l.fileInput,l.fileList,l.submitButton,l.resetButton]),r&&(e._elements.form&&e._elements.form.parent?e._elements.form.parent.replace(l.form,e._elements.form):r.dom instanceof HTMLInputElement?(r.parent.append(l.form,r),l.form.classes.add("widget"),e._elements=l,e.hide().resize(),r.on("click",function(){e.toggle()}),document.addEventListener("click",function(t,n){if(l.form.visible){for(;n=n?n.parentNode:t.target;)if(n==l.form.dom||n==r.dom)return;e.hide()}}),window.addEventListener("resize",function(){!0===o.autoResize&&e.resize()})):r.append(l.form)),e._elements=l,l.browseButton.on("click",function(){l.fileInput.dom.click()}),l.fileInput.on("change",function(r){o.multiple||(t.length=0,l.fileList.clear()),[].slice.call(r.target.files).forEach(function(o){for(var r,a=o.size,u=o.lastModifiedDate,c={},f=0;f<t.length;++f)if((r=t[f].reference).name==o.name&&r.lastModifiedDate.valueOf()==u.valueOf())return;a=a>=1073741824?(a/1073741824).toFixed(2)+i.gibiBytes:a>=1048576?(a/1048576).toFixed(2)+i.mebiBytes:a>=1024?(a/1024).toFixed(2)+i.kibiBytes:a+=i.bytes,l.fileList.add(new n("fieldset.fileinfo").append(new n("legend",{html:o.name})).append(c.name=new n("input[type=text][placeholder="+i.fileName+"][value="+o.name+"].name")).append(c.size=new n("input[type=text][placeholder="+i.fileSize+"][value="+a+"][disabled].size")).append(c.type=new n("input[type=text][placeholder="+i.fileType+"][value="+o.type+"][disabled].type")).append(c.prog=new n("progress[value=0].progress")).append(c.info=new n("span.info"))),t.push({elements:c,location:null,parent:e,reference:o,response:null,status:s.status.READY,xhr:null,get progress(){return s.status.UPLOADING==this.status?Math.round(this.elements.prog.value/this.elements.prog.max*100):NaN}})}),e.status=t.length?s.status.READY:s.status.NONE,l.submitButton.enabled=t.length}),l.form.on("submit",function(t){t.preventDefault(),e.upload()}),e.upload=function(){function n(n){for(var o in t)if(s.status.UPLOADING==t[o].status)return;l.resetButton.on("click",null),l.resetButton.value=i.reset,e.status=s.status.COMPLETED}if(l.browseButton.enabled=l.submitButton.enabled=!1,l.resetButton.value=i.cancel,e.status=s.status.UPLOADING,l.resetButton.on("click",function(e){if(e.preventDefault(),o.chunked)for(var n in t)t[n].xhr instanceof XMLHttpRequest&&t[n].xhr.abort();else t.xhr instanceof XMLHttpRequest&&t.xhr.abort()}),o.chunked){var r="number"==typeof o.chunkSize?o.chunkSize:1048576;t.forEach(function(t){var a=0,l=t.reference.size,c=t.elements.name.value,f=function(){var d=t.reference.slice(a,Math.min(l,a+r)+1,t.reference.type),m=t.xhr=new XMLHttpRequest;m.onloadstart=function(n){t.status=s.status.UPLOADING,t.elements.prog.attribs.set("max",l+(n.lengthComputable?n.total:0)),t.elements.prog.value=a,"function"==typeof e._callbacks.start&&e._callbacks.start(t)},m.upload.onprogress=function(n){n.lengthComputable&&(t.elements.prog.value=a+n.loaded),"function"==typeof e._callbacks.progress&&e._callbacks.progress(t)},m.onload=function(o){var r=o.target.status;if(r>=200&&300>r){if(t.elements.prog.attribs.set("max",l),t.elements.prog.value=a+=d.size,l>a)return"function"==typeof f&&f();t.status=s.status.COMPLETED,t.elements.info.classes.add("success"),t.elements.info.value=i.success,n(t),201==r&&(t.location=m.getResponseHeader("Content-Location")||null,t.response=m.responseText||null),"function"==typeof e._callbacks.success&&e._callbacks.success(t)}else r>=400&&(t.status=s.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=u[r]||i.failed,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t))},m.onabort=function(){t.status=s.status.ABORTED,t.elements.info.value=i.aborted,n(t),"function"==typeof e._callbacks.abort&&e._callbacks.abort(t)},m.ontimeout=function(){t.status=s.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=i.timeout,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)},m.onerror=function(){t.status=s.status.FAILED,t.elements.info.classes.add("error"),t.elements.info.value=i.refused,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)},m.open("POST",o.server,!0),m.setRequestHeader("Content-Type",d.type),m.setRequestHeader("X-File-Name",c),m.setRequestHeader("X-File-Size",l),m.send(d)};t.elements.prog.attribs.set("max",l),f()})}else{var a=t.xhr=new XMLHttpRequest,c=new FormData;a.onloadstart=function(n){t.forEach(function(t){t.status=s.status.UPLOADING,t.elements.prog.attribs.remove("max","value"),"function"==typeof e._callbacks.start&&e._callbacks.start(t)})},a.onload=function(o){var r=o.target.status;t.forEach(function(t){r>=200&&300>r?(t.status=s.status.COMPLETED,t.elements.prog.attribs.set("max",o.total||1).set("value",o.loaded||1),t.elements.info.classes.add("success"),t.elements.info.value=i.success,n(t),"function"==typeof e._callbacks.success&&e._callbacks.success(t)):r>=400&&(t.status=s.status.FAILED,t.elements.prog.attribs.set("max",o.total||1).set("value",o.loaded||0),t.elements.info.classes.add("error"),t.elements.info.value=u[r]||i.failed,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t))})},a.onabort=function(){t.forEach(function(t){t.status=s.status.ABORTED,t.elements.prog.attribs.set("max",1).set("value",0),t.elements.info.value=i.aborted,n(t),"function"==typeof e._callbacks.abort&&e._callbacks.abort(t)})},a.ontimeout=function(){t.forEach(function(t){t.status=s.status.FAILED,t.elements.prog.attribs.set("max",1).set("value",0),t.elements.info.classes.add("error"),t.elements.info.value=i.timeout,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)})},a.onerror=function(o){t.forEach(function(t){t.status=s.status.FAILED,t.elements.prog.attribs.set("max",1).set("value",0),t.elements.info.classes.add("error"),t.elements.info.value=i.refused,n(t),"function"==typeof e._callbacks.error&&e._callbacks.error(t)})},t.forEach(function(e){c.append(e.reference.name,e.reference,e.elements.name.value),e.elements.prog.dom.removeAttribute("value")}),a.open("POST",o.server,!0),a.send(c)}},l.form.on("reset",function(){t.length=0,l.fileList.clear(),l.browseButton.enabled=!0,l.submitButton.enabled=!1,l.resetButton.value=i.reset,e.status=s.status.NONE}),this},get element(){return this._parent?this._parent.dom:null},hide:function(){return this._elements.form&&(this._elements.form.visible=!1),this},get locale(){return this._i18n._id},set locale(e){return(this._i18n=Object.assign({_id:s.i18n[e]?e:"en_GB"},s.i18n.en_GB,s.i18n[e]))._id},on:function(e,t){return(e instanceof Array?e:[e]).forEach(function(e){if(-1==["start","progress","success","abort","error"].indexOf(e))throw"Unrecognized FileFunnel event: "+e;this._callbacks[e]="function"==typeof t?t:null},this),this},reset:function(){this._elements.form&&this._elements.form.dom.reset()},resize:function(e){return this._elements.form&&this._parent&&(this._elements.form.dom.style.width=(isNaN(e=Number(e))?this._parent.dom.offsetWidth:e)+"px"),this},get server(){return"string"==typeof this._options.server?this._options.server:null},set server(e){return this._options.server="string"==typeof e?e:null},show:function(){return this._elements.form&&(this._elements.form.visible=!0),this},toggle:function(){return this._elements.form&&(this._elements.form.visible=!this._elements.form.visible),this},upload:function(){}},s.i18n={en_GB:{add:"Add files",browse:"Choose file",cancel:"Cancel","delete":"Delete",reset:"Reset",upload:"Upload",bytes:" bytes",gibiBytes:" GiB",kibiBytes:" KiB",mebiBytes:" MiB",fileName:"Filename",fileSize:"Filesize",fileType:"Filetype",aborted:"Upload aborted",failed:"Upload failed",forbidden:"Unauthorised for upload",oversized:"File too big for upload",refused:"Connection refused",success:"Upload successful",timeout:"Upload timed out"}},"undefined"!=typeof window&&(window.FileFunnel=s),"object"==typeof module&&module.exports&&(module.exports=s),s}();